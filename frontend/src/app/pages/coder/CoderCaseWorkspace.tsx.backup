import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { 
  ArrowLeft, 
  User, 
  Calendar, 
  Clock, 
  Activity, 
  FileText, 
  Brain, 
  AlertTriangle, 
  CheckCircle, 
  Search, 
  Stethoscope, 
  HeartPulse, 
  ClipboardList,
  ChevronRight,
  Sparkles,
  Info
} from 'lucide-react';
import { clsx } from 'clsx';
import { toast } from 'sonner';

// --- Mock Data Types ---

interface PatientSummary {
  an: string;
  name: string;
  mrn: string;
  sex: 'Male' | 'Female';
  age: number;
  admitDate: string;
  dischargeDate: string;
  los: number;
  aiSummary: string;
}

interface ClinicalDoc {
  cc: string;
  pi: string;
  ph: string;
  fh: string;
  vitals: {
    bt: string;
    pr: string;
    rr: string;
    bp: string;
    o2: string;
  };
  diagnosis: {
    pdx: { code: string; desc: string; confidence: number; evidence: string };
    sdx: Array<{ code: string; desc: string; confidence: number; evidence: string; missing?: boolean }>;
  };
  procedures: Array<{ code: string; desc: string; confidence: number; evidence: string }>;
}

interface CodingInsight {
  drg: string;
  rw: number;
  adjRw: number;
  expectedLos: number;
  actualLos: number;
  alerts: Array<{ type: 'warning' | 'info'; message: string }>;
}

// --- Mock Data ---

const MOCK_DATA = {
  patient: {
    an: 'AN-2024-8892',
    name: 'Eleanor Rigby',
    mrn: 'HN-99281',
    sex: 'Female',
    age: 74,
    admitDate: '10 Oct 2024 08:30',
    dischargeDate: '13 Oct 2024 14:00',
    los: 3,
    aiSummary: '74-year-old female, admitted for respiratory distress and pneumonia, LOS 3 days. History of COPD.'
  } as PatientSummary,
  
  clinical: {
    cc: 'Shortness of breath for 2 days.',
    pi: 'Patient presents with worsening dyspnea, productive cough with green sputum, and fever. No chest pain. History of COPD, on home oxygen.',
    ph: 'COPD, Hypertension, T2DM.',
    fh: 'Father died of MI at 65.',
    vitals: {
      bt: '38.5°C',
      pr: '102 bpm',
      rr: '24/min',
      bp: '135/85 mmHg',
      o2: '88% RA'
    },
    diagnosis: {
      pdx: { 
        code: 'J18.9', 
        desc: 'Pneumonia, unspecified organism', 
        confidence: 0.95, 
        evidence: 'Fever, cough, desaturation, CXR consolidation' 
      },
      sdx: [
        { 
          code: 'J44.1', 
          desc: 'COPD with acute exacerbation', 
          confidence: 0.92, 
          evidence: 'Hx COPD, worsening dyspnea, wheezing' 
        },
        { 
          code: 'I10', 
          desc: 'Essential hypertension', 
          confidence: 0.88, 
          evidence: 'History, BP elevated' 
        },
        { 
          code: 'E11.9', 
          desc: 'Type 2 diabetes mellitus without complications', 
          confidence: 0.85, 
          evidence: 'Patient history' 
        },
        { 
          code: 'Z99.81', 
          desc: 'Dependence on supplemental oxygen', 
          confidence: 0.75, 
          evidence: 'Mentioned "home oxygen"', 
          missing: false 
        }
      ]
    },
    procedures: [
      { 
        code: '99223', 
        desc: 'Initial hospital care, high complexity', 
        confidence: 0.90, 
        evidence: 'Admission note, comprehensive assessment' 
      }
    ]
  } as ClinicalDoc,

  coding: {
    drg: '194',
    rw: 1.2543,
    adjRw: 1.3501,
    expectedLos: 4.5,
    actualLos: 3,
    alerts: [
      { type: 'warning', message: 'LOS (3 days) is shorter than expected (4.5 days) for DRG 194.' },
      { type: 'info', message: 'Consider verifying respiratory failure criteria to optimize RW.' }
    ]
  } as CodingInsight
};

export const CoderCaseWorkspace = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [activeSection, setActiveSection] = useState('summary');

  // --- UI Components ---

  const VitalsCard = ({ label, value, icon: Icon, alert }: any) => (
    <div className={clsx("p-2 rounded-lg border flex items-center gap-2", alert ? "bg-red-50 border-red-100" : "bg-white border-gray-200")}>
      <div className={clsx("p-1.5 rounded-full", alert ? "bg-red-100 text-red-600" : "bg-gray-100 text-gray-500")}>
        <Icon size={14} />
      </div>
      <div>
        <p className="text-[10px] text-gray-500 uppercase font-bold">{label}</p>
        <p className={clsx("text-sm font-semibold", alert ? "text-red-700" : "text-gray-900")}>{value}</p>
      </div>
    </div>
  );

  return (
    <div className="h-[calc(100vh-2rem)] bg-gray-50 flex flex-col overflow-hidden animate-fade-in">
      
      {/* Top Navigation Bar */}
      <header className="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 flex-shrink-0 z-20">
        <div className="flex items-center gap-4">
          <button 
            onClick={() => navigate('/coder/records')}
            className="p-1.5 hover:bg-gray-100 rounded-lg text-gray-500 transition-colors"
          >
            <ArrowLeft size={18} />
          </button>
          <div>
            <h1 className="text-sm font-bold text-gray-900 flex items-center gap-2">
              Case Coding Workspace
              <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] rounded-full">Inpatient</span>
            </h1>
            <p className="text-xs text-gray-500 font-mono">AN: {MOCK_DATA.patient.an}</p>
          </div>
        </div>
        
        <div className="flex items-center gap-3">
          <div className="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-100">
            <Brain size={14} />
            <span className="text-xs font-bold">AI Analysis Active</span>
          </div>
          <button className="px-4 py-1.5 bg-teal-600 text-white text-xs font-bold rounded-lg hover:bg-teal-700 shadow-sm transition-colors">
            Finalize & Submit
          </button>
        </div>
      </header>

      {/* Main Workspace Grid (3 Columns) */}
      <div className="flex-1 grid grid-cols-12 overflow-hidden">
        
        {/* 1️⃣ LEFT PANEL: Patient & Admission Summary (Cols 2) */}
        <aside className="col-span-2 bg-white border-r border-gray-200 flex flex-col overflow-y-auto">
          <div className="p-4 border-b border-gray-100">
            <h2 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Patient Profile</h2>
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 rounded-full bg-teal-100 text-teal-700 flex items-center justify-center font-bold">
                {MOCK_DATA.patient.name.charAt(0)}
              </div>
              <div>
                <p className="font-bold text-gray-900 text-sm leading-tight">{MOCK_DATA.patient.name}</p>
                <p className="text-xs text-gray-500">{MOCK_DATA.patient.sex}, {MOCK_DATA.patient.age}y</p>
              </div>
            </div>
            
            <div className="space-y-3">
              <div className="bg-gray-50 p-2.5 rounded-lg border border-gray-100">
                <p className="text-[10px] text-gray-400 uppercase font-bold mb-1">Admission Date</p>
                <div className="flex items-center gap-2 text-xs font-medium text-gray-700">
                  <Calendar size={12} />
                  {MOCK_DATA.patient.admitDate}
                </div>
              </div>
              <div className="bg-gray-50 p-2.5 rounded-lg border border-gray-100">
                <p className="text-[10px] text-gray-400 uppercase font-bold mb-1">Discharge Date</p>
                <div className="flex items-center gap-2 text-xs font-medium text-gray-700">
                  <Calendar size={12} />
                  {MOCK_DATA.patient.dischargeDate}
                </div>
              </div>
              <div className="bg-blue-50 p-2.5 rounded-lg border border-blue-100">
                <p className="text-[10px] text-blue-400 uppercase font-bold mb-1">Length of Stay</p>
                <div className="flex items-center gap-2 text-sm font-bold text-blue-700">
                  <Clock size={14} />
                  {MOCK_DATA.patient.los} Days
                </div>
              </div>
            </div>
          </div>

          <div className="p-4 bg-indigo-50/50 flex-1">
            <h2 className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-2 flex items-center gap-1">
              <Sparkles size={10} /> AI Auto-Summary
            </h2>
            <p className="text-xs text-indigo-900 leading-relaxed bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
              "{MOCK_DATA.patient.aiSummary}"
            </p>
          </div>
        </aside>

        {/* 2️⃣ CENTER PANEL: Structured Clinical Documentation (Cols 7) */}
        <main className="col-span-7 bg-gray-50/50 flex flex-col overflow-y-auto border-r border-gray-200">
          <div className="p-6 max-w-4xl mx-auto w-full space-y-6">
            
            {/* Header */}
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                <ClipboardList size={20} className="text-teal-600" />
                Clinical Documentation
              </h2>
              <span className="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500">
                Source: EMR Integration
              </span>
            </div>

            {/* Vitals Row */}
            <div className="grid grid-cols-5 gap-3">
              <VitalsCard label="Temp" value={MOCK_DATA.clinical.vitals.bt} icon={Activity} alert={parseFloat(MOCK_DATA.clinical.vitals.bt) > 37.5} />
              <VitalsCard label="Pulse" value={MOCK_DATA.clinical.vitals.pr} icon={HeartPulse} alert={parseInt(MOCK_DATA.clinical.vitals.pr) > 100} />
              <VitalsCard label="Resp" value={MOCK_DATA.clinical.vitals.rr} icon={Activity} alert={parseInt(MOCK_DATA.clinical.vitals.rr) > 20} />
              <VitalsCard label="BP" value={MOCK_DATA.clinical.vitals.bp} icon={Activity} />
              <VitalsCard label="O2 Sat" value={MOCK_DATA.clinical.vitals.o2} icon={Activity} alert={parseInt(MOCK_DATA.clinical.vitals.o2) < 90} />
            </div>

            {/* Clinical Sections */}
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="divide-y divide-gray-100">
                <section className="p-4">
                  <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Chief Complaint</h3>
                  <p className="text-sm text-gray-800">{MOCK_DATA.clinical.cc}</p>
                </section>
                <section className="p-4">
                  <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">History of Present Illness</h3>
                  <p className="text-sm text-gray-800 leading-relaxed">{MOCK_DATA.clinical.pi}</p>
                </section>
                <div className="grid grid-cols-2 divide-x divide-gray-100">
                  <section className="p-4">
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Past History</h3>
                    <p className="text-sm text-gray-800">{MOCK_DATA.clinical.ph}</p>
                  </section>
                  <section className="p-4">
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Family History</h3>
                    <p className="text-sm text-gray-800">{MOCK_DATA.clinical.fh}</p>
                  </section>
                </div>
              </div>
            </div>

            {/* Diagnosis Section */}
            <div>
              <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
                <Stethoscope size={16} className="text-teal-600" />
                Diagnoses & Coding
              </h3>
              
              <div className="space-y-3">
                {/* Principal Diagnosis */}
                <div className="bg-white p-4 rounded-xl border border-teal-200 shadow-sm relative overflow-hidden group">
                  <div className="absolute top-0 left-0 w-1 h-full bg-teal-500"></div>
                  <div className="flex justify-between items-start mb-1">
                    <span className="text-[10px] font-bold text-teal-600 uppercase tracking-wider bg-teal-50 px-2 py-0.5 rounded">Principal Diagnosis</span>
                    <span className="text-xs font-bold text-emerald-600 flex items-center gap-1">
                      <Sparkles size={10} /> {Math.round(MOCK_DATA.clinical.diagnosis.pdx.confidence * 100)}% Confidence
                    </span>
                  </div>
                  <div className="flex items-center gap-3 mb-2">
                     <span className="font-mono text-lg font-bold text-gray-900">{MOCK_DATA.clinical.diagnosis.pdx.code}</span>
                     <span className="text-sm font-medium text-gray-700">{MOCK_DATA.clinical.diagnosis.pdx.desc}</span>
                  </div>
                  <p className="text-xs text-gray-500 flex items-center gap-1.5">
                    <Search size={12} />
                    Evidence: <span className="italic">"{MOCK_DATA.clinical.diagnosis.pdx.evidence}"</span>
                  </p>
                </div>

                {/* Secondary Diagnoses */}
                <div className="space-y-2">
                  <p className="text-xs font-bold text-gray-400 uppercase tracking-wider pl-1">Secondary Diagnoses (Comorbidities)</p>
                  {MOCK_DATA.clinical.diagnosis.sdx.map((sdx, idx) => (
                    <div key={idx} className="bg-white p-3 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors flex items-start justify-between group">
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-mono text-sm font-bold text-gray-700 bg-gray-100 px-1.5 py-0.5 rounded">{sdx.code}</span>
                          <span className="text-sm text-gray-700">{sdx.desc}</span>
                        </div>
                        <p className="text-[10px] text-gray-400 pl-1">Map: {sdx.evidence}</p>
                      </div>
                      <div className="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                         <button className="p-1 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded"><AlertTriangle size={14} /></button>
                         <button className="p-1 hover:bg-teal-50 text-gray-400 hover:text-teal-600 rounded"><CheckCircle size={14} /></button>
                      </div>
                    </div>
                  ))}
                  
                  {/* Empty Slot Placeholder */}
                  <button className="w-full py-2 border-2 border-dashed border-gray-200 rounded-lg text-xs font-medium text-gray-400 hover:border-teal-400 hover:text-teal-600 transition-colors flex items-center justify-center gap-2">
                    <ClipboardList size={14} />
                    Add Secondary Diagnosis
                  </button>
                </div>
              </div>
            </div>

            {/* Procedures Section */}
            <div>
              <h3 className="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
                <Activity size={16} className="text-blue-600" />
                Procedures
              </h3>
              <div className="bg-white p-3 rounded-lg border border-gray-200">
                 {MOCK_DATA.clinical.procedures.map((proc, idx) => (
                    <div key={idx} className="flex items-center justify-between">
                       <div className="flex items-center gap-3">
                          <span className="font-mono text-sm font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded">{proc.code}</span>
                          <span className="text-sm text-gray-700">{proc.desc}</span>
                       </div>
                       <span className="text-[10px] text-gray-400">Confidence: {Math.round(proc.confidence * 100)}%</span>
                    </div>
                 ))}
              </div>
            </div>

          </div>
        </main>

        {/* 3️⃣ RIGHT PANEL: Coding Intelligence (Cols 3) */}
        <aside className="col-span-3 bg-white border-l border-gray-200 flex flex-col overflow-y-auto">
          <div className="p-4 bg-gray-900 text-white">
            <h2 className="text-sm font-bold flex items-center gap-2 mb-4">
              <Brain size={16} className="text-teal-400" />
              DRG & Resource Insight
            </h2>
            
            <div className="grid grid-cols-2 gap-4 mb-4">
              <div>
                <p className="text-[10px] text-gray-400 uppercase font-bold mb-1">DRG Code</p>
                <p className="text-2xl font-mono font-bold text-teal-400">{MOCK_DATA.coding.drg}</p>
              </div>
              <div>
                <p className="text-[10px] text-gray-400 uppercase font-bold mb-1">Relative Wt</p>
                <p className="text-xl font-mono font-bold">{MOCK_DATA.coding.rw}</p>
                <p className="text-[10px] text-gray-400">Adj: {MOCK_DATA.coding.adjRw}</p>
              </div>
            </div>
            
            <div className="bg-gray-800 p-3 rounded-lg">
               <div className="flex justify-between items-end mb-2">
                 <span className="text-xs text-gray-400">Length of Stay Analysis</span>
                 <span className="text-xs font-bold text-orange-400">Gap: -1.5 Days</span>
               </div>
               <div className="relative h-2 bg-gray-700 rounded-full mb-1">
                 <div className="absolute top-0 left-0 h-full bg-teal-500 rounded-full" style={{ width: '60%' }}></div> {/* Actual */}
                 <div className="absolute top-[-4px] left-[80%] w-0.5 h-4 bg-white"></div> {/* Expected marker */}
               </div>
               <div className="flex justify-between text-[10px] text-gray-500 font-mono">
                 <span>Actual: {MOCK_DATA.coding.actualLos}d</span>
                 <span>Expected: {MOCK_DATA.coding.expectedLos}d</span>
               </div>
            </div>
          </div>

          <div className="p-4 flex-1 bg-gray-50">
            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2">
              <Sparkles size={12} />
              AI Insights & Alerts
            </h3>
            
            <div className="space-y-3">
              {MOCK_DATA.coding.alerts.map((alert, idx) => (
                <div key={idx} className={clsx(
                  "p-3 rounded-lg border text-xs leading-relaxed flex gap-2 shadow-sm",
                  alert.type === 'warning' ? "bg-orange-50 border-orange-100 text-orange-800" : "bg-blue-50 border-blue-100 text-blue-800"
                )}>
                  {alert.type === 'warning' ? <AlertTriangle size={14} className="flex-shrink-0 mt-0.5" /> : <Info size={14} className="flex-shrink-0 mt-0.5" />}
                  <span>{alert.message}</span>
                </div>
              ))}

              <div className="p-3 rounded-lg border border-dashed border-gray-300 text-gray-400 text-center text-xs">
                AI has verified procedure codes against admission notes.
              </div>
            </div>
          </div>
          
          <div className="p-4 border-t border-gray-200 bg-white">
            <button className="w-full py-2 bg-gray-100 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-200 transition-colors mb-2">
              View DRG Grouping Logic
            </button>
            <p className="text-[10px] text-center text-gray-400">
              Last updated: Today 14:30
            </p>
          </div>
        </aside>

      </div>
    </div>
  );
};
